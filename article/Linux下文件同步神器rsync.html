<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Linux下文件同步神器rsync</title>
    <link rel="icon" href="../static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="static/css/styles.css"> <!-- 静态文件的链接 -->
    <!-- 引入 highlight.js 的 CSS 样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

</head>
<body>
    <header>
        <div class="navbar container">
            <div class="menu">
                <div class="nav-title"><a href="/index.html">各自花开</a></div>
                <ul class="nav-menu">
                    
                        <li><a href="/index.html">首页</a></li>
                        <li><a href="/categories.html">分类</a>
                        <li><a href="/tags.html">标签</a>






                        <li><a href="webnav.html">网址导航</a></li>
                        <li><a href="https://www.baidu.com" target="_blank">资源分享
                        <!-- 外部链接图标 -->
                        <img src="../static/img/分享_share.png" alt="外部链接" style="position: absolute; top: 0; right: 0; width: 12px; height: 12px;transform: translateX(100%)">
                        </a></li>
                        <li><a href="/search.html">搜索</a></li>
                    
                </ul>
            </div>
        </div>
    </header>
    <div id="app" class="container">

            
            


        <div class="main container">
                
    <div class="content article-content">
        <h3>Linux下文件同步神器rsync</h3>
        <div class="tag-container">
        








            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>linux</a>
            </span>
            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>rsync</a>
            </span>
            

        </div>
        
        <div class="container article">
            <h2>rsync的安装</h2>
<pre class="codehilite"><code class="language-bash">yum install -y rsync
</code></pre>

<h2>添加配置文件</h2>
<pre class="codehilite"><code class="language-bash">vi /etc/rsyncd.conf
uid = nobody
gid = nobody
use chroot = yes
max connection = 2
pid file = /var/run/rsyncd.pid
hosts allow = *
#hosts deny = *

[test]
path = /root/soft
auth user = rsync
read only = false
secrets file = /etc/rsyncd.secrets  #密码文件
</code></pre>

<!--more-->
<h2>创建密码文件</h2>
<pre class="codehilite"><code class="language-bash">vim /etc/rsyncd.secrets
rsync:rsync@123
</code></pre>

<h2>启动</h2>
<p>centos7下启动</p>
<pre class="codehilite"><code class="language-bash">systemctl start rsyncd
</code></pre>

<p>centos6下启动</p>
<pre class="codehilite"><code class="language-bash">rsync --daemon
</code></pre>

<p>centos6通过守护进程xinetd启动rsync</p>
<pre class="codehilite"><code class="language-bash">yum install -y xinetd
vim /etc/xinetd.d/rsync
service rsync
{
        disable = no
        flags           = IPv6
        socket_type     = stream
        wait            = no
        user            = root
        server          = /usr/bin/rsync
        server_args     = --daemon
        log_on_failure  += USERID
}
#vi /etc/service
#添加以下内容
rsync           873/tcp                 # rsync
#启动xinetd服务
/etc/init.d/xinetd start
</code></pre>

<h2>客户端安装配置</h2>
<pre class="codehilite"><code class="language-bash">#yum install -y rsync
#配置服务端指定的secrets file文件
#vi /etc/rsyncd.secrets
#format user:password
rsync:rsync@123

chmod 600 /etc/rsyncd.secrets
</code></pre>

<h2>文件同步命令</h2>
<pre class="codehilite"><code class="language-bash">rsync -avzP --password-file=/etc/rsyncd.secrets rsync@192.168.3.2::path $des_path
</code></pre>

<p><strong>参数</strong>
- -a    以递归方式传输文件，并保持文件属性。等于 -rtopgDl
- -v    详细输出，显示输出信息
- -z    压缩传输，添加--compress-level=2 2表示压缩级别
- -P    显示同步的过程及传输时的进度等信息
- --exclude=  指定排除不需要传输的文件
- --exclude-from=  将要排除的文件写入一个文件，通过该参数指定可以排除文件内的文件
- --delete  无差异同步，如果服务器上删除了，同步时也会删除本地</p>
<h2>文件实时同步inotify-tools安装配置</h2>
<h3>安装</h3>
<pre class="codehilite"><code class="language-bash">wget https://sourceforge.net/projects/inotify-tools/files/inotify-tools/3.13/inotify-tools-3.13.tar.gz/download
tar -zxvf inotify-tools-3.13.tar.gz
./configure 
make
make install
</code></pre>

<p><strong>举例</strong>
实时监控/root/test目录变化，并调用rsync同步w文件到远程目录脚本</p>
<pre class="codehilite"><code class="language-bash">#!/bin/sh

# get the current path
CURPATH=`pwd`

inotifywait -mr --timefmt '%d/%m/%y %H:%M' --format '%T %w %f' \
-e close_write /root/test | while read date time dir file; do

       FILECHANGE=${dir}${file}
       # convert absolute path to relative
       FILECHANGEREL=`echo &quot;$FILECHANGE&quot; | sed 's_'$CURPATH'/__'`

       #rsync --progress --relative -vrae 'ssh -p 22'  $FILECHANGEREL usernam@example.com:/backup/root/dir &amp;&amp; \

    ##同步的目录需注意，此处的$FILECHANGE是绝对路径，所以同步--relative参数是递归形势,不加此参数，所有文件包括子文件夹内的文件都会在同一级目录下
       rsync --progress  --relative -vzra --password-file=/etc/rsyncd.secrets $FILECHANGE rsync@192.168.3.2::test &amp;&amp; \  
       echo &quot;At ${time} on ${date}, file $FILECHANGE was backed up via rsync&quot;
done
</code></pre>
        </div>
        
    </div>



                


        </div>

    </div>
    <footer>
        
        <p>&copy; 2024 | 我的博客. 保留所有权利。</p>
    <!--    <p><a href="/privacy">隐私政策</a> | <a href="/terms">使用条款</a></p>-->
        
    </footer>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <!-- 在页面加载完成后启用代码高亮 -->
    <script>
        // 等待页面加载完成后执行高亮
        document.addEventListener('DOMContentLoaded', function() {
            // 启用 highlight.js 代码高亮
            hljs.highlightAll();
        });
    </script>


</html>