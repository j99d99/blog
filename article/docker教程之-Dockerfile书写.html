<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>docker教程之-Dockerfile书写</title>
    <link rel="icon" href="../static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="static/css/styles.css"> <!-- 静态文件的链接 -->
    <!-- 引入 highlight.js 的 CSS 样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

</head>
<body>
    <header>
        <div class="navbar container">
            <div class="menu">
                <div class="nav-title"><a href="/index.html">各自花开</a></div>
                <ul class="nav-menu">
                    
                        <li><a href="/index.html">首页</a></li>
                        <li><a href="/categories.html">分类</a>
                        <li><a href="/tags.html">标签</a>






                        <li><a href="webnav.html">网址导航</a></li>
                        <li><a href="https://www.baidu.com" target="_blank">资源分享
                        <!-- 外部链接图标 -->
                        <img src="../static/img/分享_share.png" alt="外部链接" style="position: absolute; top: 0; right: 0; width: 12px; height: 12px;transform: translateX(100%)">
                        </a></li>
                        <li><a href="/search.html">搜索</a></li>
                    
                </ul>
            </div>
        </div>
    </header>
    <div id="app" class="container">

            
            


        <div class="main container">
                
    <div class="content article-content">
        <h3>docker教程之-Dockerfile书写</h3>
        <div class="tag-container">
        








            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>docker</a>
            </span>
            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>Dockerfile</a>
            </span>
            

        </div>
        
        <div class="container article">
            <p>Dockerfile是可以被docker程序解释的脚本。由一条条命令组合而成。我们可以通过编写Dockerfile文件将应用根据自己的需求打包成docker镜像。也可以避免重复去修改镜像。</p>
<p>Dockerfile文件开头的D必须大写，在构建docker镜像的时候，通常寻找当前目录下的Dockerfile文件</p>
<!--more-->

<p>Dockerfile 常用命令介绍</p>
<p>在编写Dockerfile的时候，Dockerfile的命令总是大写。下面来看看常用的Dockerfile命令吧</p>
<p><strong>FORM</strong> </p>
<p>每个Dockerfile文件的开头都是FORM命令，后面跟着一个基础镜像，表示该Dockerfile文件基于这个基础镜像来进行构建</p>
<p><strong>MAINTAINER</strong></p>
<p>镜像维护者的基础信息</p>
<p><strong>WORKDIR</strong></p>
<p>指定工作目录，注意区分绝对路径和相对路径</p>
<p><strong>ENV和ARG</strong> </p>
<p>设置容器的环境变量，格式为key=value,当有多个变量时使用空格隔开</p>
<p>ARG构建参数，在构建docker镜像时使用的环境变量，后续容器运行时不存在这些环境变量。这和ENV有区别</p>
<p><strong>RUN</strong></p>
<p>执行命令，一个Dockerfile可以有多个RUN，按照定义顺序执行。根据Dockerfile的构建规则，每执行一条命令，镜像就会多一层。会导致镜像臃肿。所以使用RUN命令的时候最好是多条能一起执行的语句都放在一个RUN命令内执行掉。RUN有两种运行格式，一种shell方式，一种参数列表方式.</p>
<p>shell格式</p>
<pre class="codehilite"><code>RUN echo 'This is a test ..'
</code></pre>

<p>exec格式,可执行文件需要是具体路径,使用双引号</p>
<pre class="codehilite"><code>RUN [&quot;/usr/bin/echo&quot;,&quot;this is a test&quot;]
</code></pre>

<p><strong>COPY和ADD</strong> </p>
<p>COPY的时候有几种注意情况</p>
<p>当目标路径看不出是目录还是还是文件的时候，会根据原路径文件或目录名的属性自动拷贝并重命名</p>
<p>例如下面的</p>
<pre class="codehilite"><code>COPY dir /mydir
</code></pre>

<ul>
<li>
<p>当dir为文件时，mydir也是文件</p>
</li>
<li>
<p>当dir为目录时，mydir是目录，相当于拷贝dir为mydir</p>
</li>
</ul>
<p>区别于上面的命令，当目录路径是目录的时候，如果该目录不存在会先在容器内新建该文件夹，然后如果是文件则将文件拷贝到该目录，如果是目录则将目录里的内容拷贝到mydir文件夹内。</p>
<pre class="codehilite"><code>COPY dir /mydir/
</code></pre>

<p>ADD的使用和COPY一样，不过功能跟强大一些。与COPY相同的请参考COPY使用，这里介绍增加的功能。主要有两个不同点</p>
<ul>
<li>如果拷贝的是一个压缩文件，ADD命令会将其拷贝并解压到目标目录</li>
<li>如果拷贝的文件是一个url的连接形式，ADD命令会自动从该url将文件下载后解压到目标目录</li>
</ul>
<p>所以，当只是想单纯的拷贝一个文件或者压缩包的时候，建议使用COPY命令。如果拷贝后需要解压建议使用ADD命令</p>
<p><strong>CMD</strong> </p>
<p>一个Dockerfile文件中，只能有一个CMD命令，如果有多个，最后一个有效。CMD主要用来提供容器启动执行命令提供默认值。可以包含可执行文件，也可以省略，当省略可执行文件的时候，必须制定ENTRYPOINT命令</p>
<p>CMD 有三种运行格式，shell格式，exec格式和参数列表格式。使用exec格式，容器内启动的任务进程pid为1。当使用参数列表格式时，必须指定ENTRYPOINT命令</p>
<p>为ENTRYPOINT命令提供默认参数</p>
<p>CMD ["param1","param2"]
另外两种使用方式分别是 exec 模式和 shell 模式：
CMD ["executable","param1","param2"]    // 这是 exec 模式的写法，注意需要使用双引号。
CMD command param1 param2</p>
<p><strong>ENTRYPOINT</strong></p>
<p>CMD和ENTRYPOINT两者的目的一样，都是用来指定容器启动程序及参数的。如果指定了ENTRYPOINT命令，则CMD参数就不在是容器启动命令了。此时CMD的内容将作为参数传递给ENTRYPOINT命令。</p>
<p>ENTRYPOINT两种使用方式分别是 exec 模式和 shell 模式：
ENTRYPOINT ["executable","param1","param2"]    // 这是 exec 模式的写法，注意需要使用双引号。
ENTRYPOINT command param1 param2</p>
<ul>
<li>指定 ENTRYPOINT  指令为 exec 模式时，命令行上指定的参数会作为参数添加到 ENTRYPOINT 指定命令的参数列表中</li>
<li>由 CMD 指令指定默认的可选参数，当命令行没有指定参数时使用该默认参数</li>
<li>指定 ENTRYPOINT  指令为 shell 模式时，会完全忽略命令行参数</li>
<li>需要覆盖默认的 ENTRYPOINT 指令时，在启动容器的时候使用--entrypoint参数来指定覆盖命令</li>
</ul>
<p>下面是几个Dockerfile样例</p>
<p>nginx源码编译安装Dockerfile</p>
<pre class="codehilite"><code class="language-bash">FROM centos
MAINTAINER chognlai
COPY nginx-1.19.1.tar.gz /tmp
RUN tar -xvf /tmp/nginx-1.19.1.tar.gz -C /tmp/ \
        &amp;&amp; cd /tmp/nginx-1.19.1 \
        &amp;&amp; yum install -y gcc-c++ gd-devel pcre-devel openssl-devel make \
        &amp;&amp; useradd nginx -s /sbin/nologin \
        &amp;&amp; ./configure --prefix=/usr/local/nginx \
        --conf-path=/etc/nginx/nginx.conf \
        --modules-path=/etc/nginx/  \
        --sbin-path=/usr/sbin/nginx \
        --user=nginx --group=nginx \
        --with-http_ssl_module \
        --with-http_realip_module \
        --with-http_addition_module \
        --with-http_image_filter_module \
        --with-http_sub_module \
        --with-http_dav_module \
        --with-http_flv_module \
        --with-http_mp4_module \
        --with-http_gzip_static_module  \
        --with-http_random_index_module \
        --with-http_secure_link_module \
        --with-http_degradation_module  \
        --with-http_stub_status_module \
        --with-debug \
        --with-http_realip_module  \
        --with-stream \
        --with-stream_ssl_preread_module \
        &amp;&amp; make &amp;&amp; make install

#优化后的nginx.conf文件
COPY nginx.conf /etc/nginx/
EXPOSE 80 443
VOLUME /etc/nginx/vhosts

CMD [&quot;nginx&quot;,&quot;-g&quot;,&quot;daemon off;&quot;]
</code></pre>

<p>mysql</p>
<p>基于官方镜像修改后的Dockerfile</p>
<pre class="codehilite"><code>FROM mysql:5.7.30
MAINTAINER chonglai
COPY my.cnf /etc/mysql/my.cnf

VOLUME /var/lib/mysql
EXPOSE 3306

CMD [&quot;mysqld&quot;]
</code></pre>

<p>nginx+php</p>
<pre class="codehilite"><code class="language-bash">FROM centos:7
MAINTAINER chognlai

RUN yum install -y wget epel-release &amp;&amp; \
        wget https://rpms.remirepo.net/enterprise/remi-release-7.rpm \
        &amp;&amp; rpm -vih remi-release-7.rpm \
        &amp;&amp; yum install -y php74-php-fpm php74-php-gd php74-php-mbstring


COPY nginx-1.19.1.tar.gz /tmp
RUN tar -xvf /tmp/nginx-1.19.1.tar.gz -C /tmp/ \
        &amp;&amp; cd /tmp/nginx-1.19.1 \
        &amp;&amp; yum install -y gcc-c++ gd-devel pcre-devel openssl-devel make \
        &amp;&amp; useradd nginx -s /sbin/nologin \
        &amp;&amp; ./configure --prefix=/usr/local/nginx \
        --conf-path=/etc/nginx/nginx.conf \
        --modules-path=/etc/nginx/  \
        --sbin-path=/usr/sbin/nginx \
        --user=nginx --group=nginx \
        --with-http_ssl_module \
        --with-http_realip_module \
        --with-http_addition_module \
        --with-http_image_filter_module \
        --with-http_sub_module \
        --with-http_dav_module \
        --with-http_flv_module \
        --with-http_mp4_module \
        --with-http_gzip_static_module  \
        --with-http_random_index_module \
        --with-http_secure_link_module \
        --with-http_degradation_module  \
        --with-http_stub_status_module \
        --with-debug \
        --with-http_realip_module  \
        --with-stream \
        --with-stream_ssl_preread_module \
        &amp;&amp; make &amp;&amp; make install

COPY nginx.conf /etc/nginx/
EXPOSE 80 443
VOLUME /etc/nginx/vhosts

CMD /opt/remi/php74/root/sbin/php-fpm &amp;&amp; nginx -g &quot;daemon off;&quot;
</code></pre>

<p>Dockerfile的构建命令如下：</p>
<p>docker build -t name:tag .</p>
        </div>
        
    </div>



                


        </div>

    </div>
    <footer>
        
        <p>&copy; 2024 | 我的博客. 保留所有权利。</p>
    <!--    <p><a href="/privacy">隐私政策</a> | <a href="/terms">使用条款</a></p>-->
        
    </footer>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <!-- 在页面加载完成后启用代码高亮 -->
    <script>
        // 等待页面加载完成后执行高亮
        document.addEventListener('DOMContentLoaded', function() {
            // 启用 highlight.js 代码高亮
            hljs.highlightAll();
        });
    </script>


</html>