<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ldap安装、备份恢复以及密码管理</title>
    <link rel="icon" href="../static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="static/css/styles.css"> <!-- 静态文件的链接 -->
    <!-- 引入 highlight.js 的 CSS 样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

</head>
<body>
    <header>
        <div class="navbar container">
            <div class="menu">
                <div class="nav-title"><a href="/index.html">各自花开</a></div>
                <ul class="nav-menu">
                    
                        <li><a href="/index.html">首页</a></li>
                        <li><a href="/categories.html">分类</a>
                        <li><a href="/tags.html">标签</a>






                        <li><a href="webnav.html">网址导航</a></li>
                        <li><a href="https://www.baidu.com" target="_blank">资源分享
                        <!-- 外部链接图标 -->
                        <img src="../static/img/分享_share.png" alt="外部链接" style="position: absolute; top: 0; right: 0; width: 12px; height: 12px;transform: translateX(100%)">
                        </a></li>
                        <li><a href="/search.html">搜索</a></li>
                    
                </ul>
            </div>
        </div>
    </header>
    <div id="app" class="container">

            
            


        <div class="main container">
                
    <div class="content article-content">
        <h3>ldap安装、备份恢复以及密码管理</h3>
        <div class="tag-container">
        








            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>linux</a>
            </span>
            

        </div>
        
        <div class="container article">
            <h1>ldap安装</h1>
<pre class="codehilite"><code class="language-bash">start.sh
#!/bin/bash -e
SERVICE=ldap-service
HOST_NAME=ldap-server
LDAP_DOMAIN=eryajf.net
LDAP_DC=eryajf
LDAP_DC_ORG=net
NETWORK_ADAPTER=eth0
PASSWORD=123456
OPENLDAP=&quot;1.5.0&quot;
PHPLDAPADMIN=&quot;0.9.0&quot;
HTTPS_PORT=88
OPENLDAP_PORT=389
docker run \
    -p ${OPENLDAP_PORT}:389 \
    --name ${SERVICE} \
    --hostname ${HOST_NAME} \
    --env LDAP_ORGANISATION=&quot;WPT-Group&quot; \
    --env LDAP_DOMAIN=${LDAP_DOMAIN} \
    --env LDAP_ADMIN_PASSWORD=${PASSWORD} \
    --detach osixia/openldap:${OPENLDAP}
docker run \
    -p ${HTTPS_PORT}:80 \
    --name ${SERVICE}-admin \
    --hostname ${HOST_NAME}-admin \
    --link ${SERVICE}:${HOST_NAME} \
    --env PHPLDAPADMIN_LDAP_HOSTS=${HOST_NAME} \
    --env PHPLDAPADMIN_HTTPS=false \
    --detach \
    osixia/phpldapadmin:${PHPLDAPADMIN}
sleep 1
echo &quot;-----------------------------------&quot;
PHPLDAP_IP=$(docker inspect -f &quot;{{ .NetworkSettings.IPAddress }}&quot; ${SERVICE})
docker exec ${SERVICE} ldapsearch -x -H ldap://${PHPLDAP_IP}:389 -b &quot;dc=${LDAP_DC},dc=${LDAP_DC_ORG}&quot; -D &quot;cn=admin,dc=${LDAP_DC},dc=${LDAP_DC_ORG}&quot; -w ${PASSWORD}
echo &quot;-----------------------------------&quot;
PUB_IP=$(ifconfig ${NETWORK_ADAPTER} |grep &quot;inet&quot;|awk '{print $2}')
echo &quot;Go to: https://${PUB_IP}:${HTTPS_PORT}&quot;
echo &quot;Login DN: cn=admin,dc=${LDAP_DC},dc=${LDAP_DC_ORG}&quot;
echo &quot;Password: ${PASSWORD}&quot;
</code></pre>

<h1>创建两个基本组织People和Group</h1>
<pre class="codehilite"><code class="language-bash">docker exec -it ldap-service bash
root@ldap-server:/# cat &lt;&lt; EOF | ldapadd -x -D &quot;cn=admin,dc=eryajf,dc=net&quot; -w 123456
dn: ou=People,dc=eryajf,dc=net
objectClass: organizationalUnit
ou: people

dn: ou=Group,dc=eryajf,dc=net
objectClass: organizationalUnit
ou: group
EOF
</code></pre>

<h1>创建用户</h1>
<pre class="codehilite"><code class="language-bash"># 用户一
cat &lt;&lt; EOF | ldapadd -x -D cn=admin,dc=eryajf,dc=net -w 123456
dn: uid=liqilong,ou=People,dc=eryajf,dc=net
uid: liqilong
cn: liqilong
sn: liqilong
displayName: liqilong
objectClass: posixAccount
objectClass: top
objectClass: person
objectClass: shadowAccount
objectClass: inetOrgPerson
gecos: System Manager
loginShell: /bin/bash
homeDirectory: /home/liqilong
userPassword: liqilong
uidNumber: 1000
gidNumber: 1009
mobile: 15638888888
mail: liqilong@eryajf.net
postalAddress: Hangzhou
EOF


# 用户二
cat &lt;&lt; EOF | ldapadd -x -D cn=admin,dc=eryajf,dc=net -w 123456
dn: uid=zhangsan,ou=People,dc=eryajf,dc=net
uid: zhangsan
cn: zhangsan
sn: zhangsan
displayName: zhangsan
objectClass: posixAccount
objectClass: top
objectClass: person
objectClass: shadowAccount
objectClass: inetOrgPerson
gecos: System Manager
loginShell: /bin/bash
homeDirectory: /home/zhangsan
userPassword: zhangsan
uidNumber: 1000
gidNumber: 1009
mobile: 15638888888
mail: zhangsan@eryajf.net
postalAddress: Hangzhou
EOF

# 用户三
cat &lt;&lt; EOF | ldapadd -x -D cn=admin,dc=eryajf,dc=net -w 123456
dn: uid=zhaosi,ou=People,dc=eryajf,dc=net
uid: zhaosi
cn: zhaosi
sn: zhaosi
displayName: zhaosi
objectClass: posixAccount
objectClass: top
objectClass: person
objectClass: shadowAccount
objectClass: inetOrgPerson
gecos: System Manager
loginShell: /bin/bash
homeDirectory: /home/zhaosi
userPassword: zhaosi
uidNumber: 1000
gidNumber: 1009
mobile: 15638888888
mail: zhaosi@eryajf.net
postalAddress: Hangzhou
EOF
</code></pre>

<h1>创建用户组</h1>
<pre class="codehilite"><code class="language-bash">cat &lt;&lt; EOF | ldapadd -x -D cn=admin,dc=eryajf,dc=net -w 123456
dn: cn=ops,ou=Group,dc=eryajf,dc=net
cn: ops
gidNumber: 66
objectClass: top
objectClass: posixGroup

dn: cn=dev,ou=Group,dc=eryajf,dc=net
cn: dev
gidNumber: 66
objectClass: top
objectClass: posixGroup

dn: cn=jenkins,ou=Group,dc=eryajf,dc=net
cn: jenkins
gidNumber: 66
objectClass: top
objectClass: posixGroup
EOF
</code></pre>

<h1>用户 分组(将用户添加到不同的组)</h1>
<pre class="codehilite"><code class="language-bash"># 把用于加入某一个组
cat &lt;&lt; EOF | ldapmodify -x -D cn=admin,dc=eryajf,dc=net -w 123456
dn: cn=ops,ou=Group,dc=eryajf,dc=net
changetype: modify
add: memberuid
memberuid: liqilong

dn: cn=ops,ou=Group,dc=eryajf,dc=net
changetype: modify
add: memberuid
memberuid: zhaosi
EOF
</code></pre>

<h1>数据备份</h1>
<h3>备份</h3>
<pre class="codehilite"><code class="language-bash"># 数据备份到/data/ldap/bak目录

mkdir /data/ldap/bak
docker exec -it ldap-service /bin/bash -c 'slapcat -v -l ldap_backup.ldif'
docker cp ldap-service:/ldap_backup.ldif  /data/ldap/bak
docker exec -it ldap-service /bin/bash -c 'rm -f /ldap_backup.ldif'
</code></pre>

<h3>对备份文件进行处理(删除一些不必要的时间状态数据)</h3>
<pre class="codehilite"><code class="language-bash"># 新建一个文件
cat &gt; openldap-backup.synax &lt;&lt; EOF
/^creatorsName: /d
/^modifiersName: /d
/^modifyTimestamp: /d
/^structuralobjectClass: /d
/^createTimestamp: /d
/^entryUUID: /d
/^entryCSN: /d
EOF

# 根据新建文件处理备份文件后生成新的文件
cat ldap_backup.ldif | sed -f openldap-backup.synax &gt; new.ldif
[root@ops-eryajf-test-2 bak]$cat ldap_backup.ldif | wc -l
178
[root@ops-eryajf-test-2 bak]$cat new.ldif | wc -l
118
</code></pre>

<h3>恢复</h3>
<pre class="codehilite"><code class="language-bash">docker cp new.ldif ldap-service:/
docker  exec -it ldap-service /bin/bash -c 'ldapadd -H ldap://192.168.10.114 -x -D &quot;cn=admin,dc=dc=eryajf,dc=net&quot; -f /new.ldif -w 123456'
</code></pre>

<h4>恢复报错解决</h4>
<pre class="codehilite"><code class="language-bash">## 报错一
ldapadd -x -D &quot;cn=admin,dc=eryajf,dc=net&quot; -w 123465 -f new.ldif
adding new entry &quot;dc=eryajf,dc=net&quot;
ldap_add: Constraint violation (19)
    additional info: structuralObjectClass: no user modification allowed
### 解决方法，过滤掉一些系统规则即可
cat &gt;slapcat.regex &lt;&lt;EOF
/^creatorsName: /d
/^createTimestamp: /d
/^modifiersName: /d
/^modifyTimestamp: /d
/^structuralObjectClass: /d
/^entryUUID: /d
/^entryCSN: /d
EOF 

cat new.ldif | sed -f slapcat.regex &gt; neww.ldif

## 报错二
ldapadd -x -D &quot;cn=admin,dc=eryajf,dc=net&quot; -w 123465 -f neww.ldif
adding new entry &quot;dc=eryajf,dc=net&quot;
ldap_add: Already exists (68)

### 解决方法
删除已经存在的条目段
</code></pre>

<h1>配置self-service-password实现ldap用户自行修改和重置密码</h1>
<h2>安装</h2>
<pre class="codehilite"><code class="language-bash">docker run -p 80:80 \
    --restart always \
    -v /home/dev/ssp.conf.php:/var/www/conf/config.inc.local.php \
    -it ltbproject/self-service-password:latest
</code></pre>

<h2>配置</h2>
<p>默认配置在容器内的/var/www/conf/config.inc.php,其中包含了config.inc.local.php配置项，我们只需要修改config.inc.php来进行覆盖即可</p>
<pre class="codehilite"><code>## ssp.conf.php
&lt;?php // My SSP configuration
$keyphrase = &quot;mysecret&quot;;
$debug = false;
$ldap_url = &quot;ldap://192.168.248.128:389&quot;;
$ldap_starttls = false;
$ldap_binddn = &quot;cn=admin,dc=hehutek,dc=com&quot;;
$ldap_bindpw = '123456';
$ldap_base = &quot;dc=hehutek,dc=com&quot;;
$ldap_login_attribute = &quot;uid&quot;;
$ldap_fullname_attribute = &quot;cn&quot;;
$ldap_filter = &quot;(&amp;(objectClass=person)($ldap_login_attribute={login}))&quot;;
$ldap_use_exop_passwd = false;
$ldap_use_ppolicy_control = false;
$use_sms = false;
$use_questions = false;
$mail_address_use_ldap = true;
$mail_from = &quot;j99d99@163.com&quot;;
$mail_from_name = &quot;Self Service Password&quot;;
$mail_signature = &quot;&quot;;
$notify_on_change = false;
$mail_sendmailpath = '/usr/sbin/sendmail';
$mail_protocol = 'smtp';
$mail_smtp_debug = 0;
$mail_debug_format = 'error_log';
$mail_smtp_host = 'smtp.163.com';
$mail_smtp_auth = true;
$mail_smtp_user = 'j99d99';
$mail_smtp_pass = 'YPHDGPCTWPTNEAUF';
$mail_smtp_port = 25;
$mail_smtp_timeout = 30;
$mail_smtp_keepalive = false;
$mail_smtp_secure = 'tls';
$mail_smtp_autotls = true;
$mail_smtp_options = array();
$mail_contenttype = 'text/plain';
$mail_wordwrap = 0;
$mail_charset = 'utf-8';
$mail_priority = 3;
?&gt;
</code></pre>
        </div>
        
    </div>



                


        </div>

    </div>
    <footer>
        
        <p>&copy; 2024 | 我的博客. 保留所有权利。</p>
    <!--    <p><a href="/privacy">隐私政策</a> | <a href="/terms">使用条款</a></p>-->
        
    </footer>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <!-- 在页面加载完成后启用代码高亮 -->
    <script>
        // 等待页面加载完成后执行高亮
        document.addEventListener('DOMContentLoaded', function() {
            // 启用 highlight.js 代码高亮
            hljs.highlightAll();
        });
    </script>


</html>