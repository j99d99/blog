<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>linux虚拟机kvm基础使用</title>
    <link rel="icon" href="../static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="../static/css/styles.css"> <!-- 静态文件的链接 -->
    <!-- 引入 highlight.js 的 CSS 样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

</head>
<body>
    <header>
        <div class="navbar container">
            <div class="menu">
                <div class="nav-title"><a href="/index.html">各自花开</a></div>
                <ul class="nav-menu">
                    
                        <li><a href="/index.html">首页</a></li>
                        <li><a href="/categories.html">分类</a>
                        <li><a href="/tags.html">标签</a>






                        <li><a href="webnav.html">网址导航</a></li>
                        <li><a href="https://www.baidu.com" target="_blank">资源分享
                        <!-- 外部链接图标 -->
                        <img src="../static/img/分享_share.png" alt="外部链接" style="position: absolute; top: 0; right: 0; width: 12px; height: 12px;transform: translateX(100%)">
                        </a></li>
                        <li><a href="/search.html">搜索</a></li>
                    
                </ul>
            </div>
        </div>
    </header>
    <div id="app" class="container">

            
            


        <div class="main container">
                
    <div class="content article-content">
        <h3>linux虚拟机kvm基础使用</h3>
        <div class="tag-container">
        








            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>linux</a>
            </span>
            

        </div>
        
        <div class="container article">
            <h2>kvm的安装配置</h2>
<p><strong>安装</strong></p>
<pre class="codehilite"><code class="language-bash">yum install kvm kmod-kvm qemu kvm-qemu-img virt-viewer virt-manager libvirt
</code></pre>

<p><strong>网卡配置</strong><br />
- 1.安装桥接工具</p>
<pre class="codehilite"><code class="language-bash">yum install bridge-utils tunctl
</code></pre>

<ul>
<li>2.配置桥接</li>
</ul>
<pre class="codehilite"><code class="language-bash">cd /etc/sysconfig/network-scripts/

cp ifcfg-eth0 ifcfg-br0
#修改ifcg-eth0
vim ifcfg-eth0 
DEVICE=eth0
HWADDR=FC:AA:14:42:8A:4C
TYPE=Ethernet
UUID=9e1ebd3e-2606-417c-86d0-ce771d449e61
ONBOOT=yes
NM_CONTROLLED=yes
BRIDGE=br0

#修改ifcg-br0
vim ifcfg-br0 
DEVICE=br0
HWADDR=FC:AA:14:42:8A:4C
TYPE=Bridge
UUID=9e1ebd3e-2606-417c-86d0-ce771d449e61
ONBOOT=yes
NM_CONTROLLED=yes
BOOTPROTO=static
IPADDR=10.0.0.161
NETMASK=255.255.255.0
GATEWAY=10.0.0.1
</code></pre>

<h2>使用</h2>
<h3>创建磁盘</h3>
<pre class="codehilite"><code class="language-bash"># 创建磁盘
qemu-img create -f qcow2 /kvm/TEST-102.img 30G

#查看kvm磁盘格式
qemu-img info /kvm/TEST-102.img
</code></pre>

<h3>调整默认网卡模式</h3>
<pre class="codehilite"><code class="language-bash">#vnc模式
virt-install --virt-type kvm --name TEST-102 --ram 4096  \
 --disk /data/KvmDisk/TEST-102.img,format=qcow2   --network network=default \
 --graphics vnc,listen=0.0.0.0,port=20000 --noautoconsole   \
 --os-type=linux --os-variant=rhel6   --cdrom=/data/iso/CentOS-6.5-x86_64-minimal.iso
#location模式
virt-install --name=TEST-101 --ram=4096 --vcpus=4 --os-type=linux \
--disk path=/data/KvmDisk/TEST-101.img,size=30,format=qcow2,bus=virtio,cache=writeback\
 --location=nfs://10.0.0.161:/data/CentosImg/ --network bridge=br0,model=virtio \
--mac=52:54:00:33:1F:6F --extra-args='console=ttyS'
</code></pre>

<h3>创建虚拟机</h3>
<pre class="codehilite"><code class="language-bash">桥接模式
virt-install --name=TEST-102 \
--ram=4096 \
--vcpus=4 \
--os-type=linux \
--disk /kvm/TEST-102.img,size=20,format=qcow2,bus=virtio,cache=writeback \
--network bridge=br0,model=virtio \
--extra-args='console=ttyS0 ks=nfs:10.0.0.161:/centosinstall/ks.cfg' \
--location nfs:10.0.0.161:/centosinstall
</code></pre>

<p><strong>注释:</strong>
--name 虚拟机名
--ram 内存大小
--vcpus cpu内核
--disk指定虚拟磁盘的位置,此种方式的磁盘格式是raw，不能使用快照功能,如需使用快照功能,磁盘必须是qcow2格式
qcow2格式磁盘需事先创建</p>
<p>通过配置文件修改网卡模式</p>
<pre class="codehilite"><code class="language-yaml">&lt;interface type='network'&gt;
      &lt;mac address='52:54:00:9e:44:e0'/&gt;
      &lt;source network='default'/&gt;
      &lt;model type='virtio'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;
&lt;/interface&gt;                         
</code></pre>

<p>修改为</p>
<pre class="codehilite"><code class="language-yaml">&lt;interface type='bridge'&gt;
      &lt;mac address='52:54:00:9e:44:e0'/&gt;
      &lt;source bridge='br0'/&gt;
      &lt;model type='virtio'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/&gt;
&lt;/interface&gt;                         
</code></pre>

<h3>虚拟机重命名</h3>
<p>```wp-block-preformatted bash
virsh destroy server_monitor
cd /etc/libvirt/qemu
virsh dumpxml server_monitor &gt; 192.16.1.185.xml
vim 192.16.1.185.xml</p>
<h1>修改server_monitor为192.16.1.185</h1>
<p>virsh undefine server_monitor
virsh define 192.16.1.185.xml
virsh start 
192.16.1.185</p>
<pre class="codehilite"><code>### 使用虚拟机
启动虚拟机

```bash
virsh start TEST-101
</code></pre>

<p>使用配置文件启动虚拟机</p>
<pre class="codehilite"><code class="language-bash">virsh create /etc/libvirt/qemu/TEST-101.xml
</code></pre>

<p>启动网卡(启动默认的default网卡)</p>
<pre class="codehilite"><code class="language-bash">virsh net-start default
</code></pre>

<p>设置虚拟机开机自启动</p>
<pre class="codehilite"><code class="language-bash">virsh autostart TEST-102
</code></pre>

<p>解除开机自启动</p>
<pre class="codehilite"><code class="language-bash">virsh autostart --disable TEST-102
</code></pre>

<p>调整虚拟机配置</p>
<pre class="codehilite"><code class="language-bash">virsh  edit TEST-101

#重启生效
virsh destroy TEST-101
virsh start TEST-101
</code></pre>

<p>关机</p>
<pre class="codehilite"><code class="language-bash">virsh destroy TEST-101
#或者
virsh shutdown TEST-101(需虚拟机开启acpid服务)
</code></pre>

<p>删除已有虚拟机</p>
<pre class="codehilite"><code class="language-bash">virsh destroy TEST-101(关机)
virsh undefine TEST-101(删除)
</code></pre>

<p>挂起</p>
<pre class="codehilite"><code class="language-bash">virsh suspend TEST-101
</code></pre>

<p>恢复</p>
<pre class="codehilite"><code class="language-bash">virs resume TEST-101
</code></pre>

<h3>虚拟机迁移</h3>
<p>迁移前需先关机</p>
<pre class="codehilite"><code class="language-bash">virsh shutdown TEST-101
virsh dumpxml TEST-101 &gt; /etc/libvirt/qemu/TEST-105.xml
virsh domblklist TEST-102 #查看磁盘文件位置
rsync -av /kvm/TEST-101.img /kvm/TEST-105.img
</code></pre>

<p><strong>注意:</strong>
远程迁移的话,将xml配置文件和img磁盘文件拷贝到相关目录下面,如果迁移到本机,则需要修改冲突的地方,比如:虚拟机名,磁盘路径等..</p>
<h3>克隆虚拟机</h3>
<p>克隆前需先关机<br />
关于virsh shutdown TEST-101不起作用的说明：<br />
原因：需借助虚拟机的acpid服务,所以前提是安装并开启acpid服务<br />
登录虚拟机</p>
<p>```wp-block-preformatted bash
virsh console TEST-101
yum install -y acpid
/etc/init.d/acpid start
退出连接(快捷键ctrl+])</p>
<pre class="codehilite"><code>克隆命令:

```bash
virt-clone --original TEST-101 --name TEST-105 --file /kvm/TEST-105.img
</code></pre>

<h3>磁盘格式转换</h3>
<pre class="codehilite"><code class="language-bash">qemu-img convert -f raw -O qcow2 /kvm/TEST-101.img /kvm/TEST-101.qcow2
</code></pre>

<p>使用转换后的磁盘,需要修改虚拟机的配置文件</p>
<pre class="codehilite"><code class="language-bash">virsh edit TEST-101
将type='raw'修改成type='qcow2'
将file='/kvm/TEST-101.img'修改成file='/kvm/TEST-101.qcow2'
重启虚拟机
</code></pre>

<h3>快照</h3>
<p>raw格式的磁盘无法使用快照功能,使用快照前需将磁盘转换成qcow2格式,方法见上</p>
<pre class="codehilite"><code class="language-bash">virsh snapshot-create TEST-101
</code></pre>

<p>查看快照</p>
<pre class="codehilite"><code class="language-bash">virsh snapshot-list TEST-102
\[root@KVM-TEST ~\]# virsh snapshot-list TEST-102  
 Name                 Creation Time             State
 1389985501           2014-01-18 03:05:01 +0800 running
</code></pre>

<p>恢复快照</p>
<pre class="codehilite"><code class="language-bash">virsh snapshot-revert TEST-102 1389985501
</code></pre>

<p>删除快照</p>
<pre class="codehilite"><code class="language-bash">virsh snapshot-delete TEST-102 1389985501
</code></pre>

<h3>磁盘扩容</h3>
<p>raw格式磁盘扩容</p>
<pre class="codehilite"><code class="language-bash">qemu-img resize /kvm/TEST-101.img +10G
</code></pre>

<p>查看磁盘信息</p>
<pre class="codehilite"><code class="language-bash">qemu-img info /kvm/TEST-101.img
注：扩容后的磁盘在系统内是没有分区的,需要对其进行分区
</code></pre>

<p>增加磁盘</p>
<pre class="codehilite"><code class="language-bash">qemu-img create -f raw /kvm/TEST-101-01.img 20G
</code></pre>

<p>修改虚拟机配置文件</p>
<pre class="codehilite"><code class="language-bash">virsh edit TEST-101
</code></pre>

<p>添加如下内容</p>
<pre class="codehilite"><code class="language-yaml">&lt;disk type='file' device='disk'&gt;
      &lt;driver name='qemu' type='raw' cache='writeback'/&gt;
      &lt;source file='/kvm/TEST-101-01.img'/&gt;
      &lt;target dev='vdb' bus='virtio'/&gt;
      &lt;address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/&gt;
&lt;/disk&gt;
</code></pre>

<p>重新虚拟机生效</p>
<p><strong>注意</strong>
qcow2格式磁盘扩容同raw,需要注意的是<br />
qemu-img resize 时提示'This image format does not support resize',则排查是否创建时添加参数'preallocation=metadata'<br />
如果有此参数,则不能使用resize</p>
<h3>查看网卡列表</h3>
<pre class="codehilite"><code class="language-bash">virsh domiflist TEST-102
</code></pre>

<h3>增加网卡</h3>
<ul>
<li>1.临时增加网卡(重启失效)</li>
</ul>
<pre class="codehilite"><code class="language-bash">virsh attach-interface TEST-101 --type bridge --source br0
</code></pre>

<ul>
<li>2.保存到配置,重启就不会失效</li>
</ul>
<pre class="codehilite"><code class="language-bash">virsh dumpxml TEST-101 &gt;/etc/libvirt/qemu/TEST-101.xml
</code></pre>

<p>以配置文件的方式重启</p>
<pre class="codehilite"><code class="language-bash">virsh create /etc/libvirt/qemu/TEST-101.xml
</code></pre>

<h3>kvm重装系统</h3>
<p>添加cdrom</p>
<pre class="codehilite"><code class="language-bash">&lt;disk type='file' device='cdrom'&gt;
      &lt;source file='/var/lib/libvirt/images/ubuntu.iso'/&gt; //光盘镜像路径
      &lt;target dev='hdb' bus='ide'/&gt;
&lt;/disk&gt;
</code></pre>

<p>修改启动</p>
<pre class="codehilite"><code class="language-bash">&lt;boot dev='cdrom'/&gt;  // 光盘启动为首选启动项
&lt;boot dev='hd'/&gt;     // 硬盘启动为次要启动项
</code></pre>

<p>保存后启动虚拟机，即从光盘开始启动</p>
        </div>
        
    </div>



                


        </div>

    </div>
    <footer>
        
        <p>&copy; 2024 | 我的博客. 保留所有权利。</p>
    <!--    <p><a href="/privacy">隐私政策</a> | <a href="/terms">使用条款</a></p>-->
        
    </footer>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <!-- 在页面加载完成后启用代码高亮 -->
    <script>
        // 等待页面加载完成后执行高亮
        document.addEventListener('DOMContentLoaded', function() {
            // 启用 highlight.js 代码高亮
            hljs.highlightAll();
        });
    </script>


</html>