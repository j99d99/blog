<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nginx+keepalived高可用配置</title>
    <link rel="icon" href="../static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="static/css/styles.css"> <!-- 静态文件的链接 -->
    <!-- 引入 highlight.js 的 CSS 样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

</head>
<body>
    <header>
        <div class="navbar container">
            <div class="menu">
                <div class="nav-title"><a href="/index.html">各自花开</a></div>
                <ul class="nav-menu">
                    
                        <li><a href="/index.html">首页</a></li>
                        <li><a href="/categories.html">分类</a>
                        <li><a href="/tags.html">标签</a>






                        <li><a href="webnav.html">网址导航</a></li>
                        <li><a href="https://www.baidu.com" target="_blank">资源分享
                        <!-- 外部链接图标 -->
                        <img src="../static/img/分享_share.png" alt="外部链接" style="position: absolute; top: 0; right: 0; width: 12px; height: 12px;transform: translateX(100%)">
                        </a></li>
                        <li><a href="/search.html">搜索</a></li>
                    
                </ul>
            </div>
        </div>
    </header>
    <div id="app" class="container">

            
            


        <div class="main container">
                
    <div class="content article-content">
        <h3>nginx+keepalived高可用配置</h3>
        <div class="tag-container">
        








            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>linux</a>
            </span>
            

        </div>
        
        <div class="container article">
            <h4>服务器IP:</h4>
<pre class="codehilite"><code>    server_ip
        172.16.88.179
        172.16.88.180
    vip
        172.16.88.178
</code></pre>

<h4>软件版本及下载</h4>
<pre class="codehilite"><code>    http://tengine.taobao.org/download/tengine-2.1.2.tar.gz
    http://www.keepalived.org/software/keepalived-1.3.2.tar.gz
</code></pre>

<!--more-->
<h4>nginx安装</h4>
<p>参加<a href="/linux/nginx-install-by-source-code">nginx的安装文档</a></p>
<h4>keepalived安装</h4>
<pre class="codehilite"><code>tar zxvf keepalived-1.3.2.tar.gz
cd keepalived-1.3.2
./configure --sysconf=/etc
make &amp;&amp; make install 
ln -s /usr/local/sbin/keepalived /sbin/keepalived
cp  keepalived/etc/init.d/keepalived /etc/init.d/
chkconfig --add keepalived
chkconfig keepalived on
</code></pre>

<h4>配置nginx+keepalived</h4>
<h5>在172.16.88.179上</h5>
<p>创建nginx服务监测脚本</p>
<pre class="codehilite"><code>vim /etc/keepalived/chk_nginx.sh
#!/bin/bash
# description:
# 查看nginx进程是否存在，如果不存在则启动nginx
# 如果启动失败，则停止keepalived
status=$(ps -C nginx --no-heading|wc -l)
if [ &quot;${status}&quot; = &quot;0&quot; ]; then
        /usr/sbin/nginx
        status2=$(ps -C nginx --no-heading|wc -l)
        if [ &quot;${status2}&quot; = &quot;0&quot;  ]; then
                service keepalived stop
        fi
fi
</code></pre>

<p>添加可执行权限</p>
<pre class="codehilite"><code>chmod +x /etc/keepalived/chk_nginx.sh
</code></pre>

<h5>配置keepalived.conf</h5>
<pre class="codehilite"><code>mv /etc/keepalived/keepalived.conf{,.bak}

vim /etc/keepalived/keepalived.conf
#主配置文件
#定义监控脚本
vrrp_script chk_nginx {
        script &quot;/etc/keepalived/chk_nginx.sh&quot;   #脚本位置
        interval 2  #检查时间间隔,单位秒
        weight 2    #定义失败时对应的权重减少值
        fall 3      #定义多少次失败则判定失败(检测3次失败,就认为失败)
        rise 2      #判定成功检测次数(检测二次成功,就认为在线)
}


vrrp_instance VI_1 {
    state MASTER    #角色
    interface eth0  #监听的网卡
    virtual_router_id 51    #虚拟路由标志
    priority 100    #优先级
    advert_int 1    #检查时间间隔，单位秒
    authentication {
        auth_type PASS  #验证类型
        auth_pass 1111  #验证密码
    }

    track_script {
        chk_nginx
    }

    virtual_ipaddress {
        172.16.88.178   #vip
    }
}
</code></pre>

<h5>拷贝配置文件到172.16.88.180</h5>
<pre class="codehilite"><code>scp /etc/keepalived/keepalived.conf root@172.16.88.180:/etc/keepalived/
scp /etc/keepalived/chk_nginx.sh root@172.16.88.180:/etc/keepalived/
</code></pre>

<h5>在172.16.88.180上</h5>
<p>修改从172.16.88.179拷贝过来的配置文件/etc/keepalived/keepalived.conf</p>
<pre class="codehilite"><code>vim /etc/keepalived/keepalived.conf

#主配置文件
global_defs {
   notification_email {     #设置管理员的email邮箱信息
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc    #通知邮件来源
   smtp_server 127.0.0.1    #设置邮件服务器地址为本地
   smtp_connect_timeout 30  #设置连接超时时间
   router_id LVS_DEVEL      #设置本keepalived的ID名称
   vrrp_skip_check_adv_addr
#   vrrp_strict             ##严格遵守vrrp协议，下面这些功能将会禁止：1.VIP;2.unicast(单播) peers;3.vrrp 版本2的ipv6功能,开启此选项会开启防火墙并DROP所以VIP请求
#   vrrp_garp_interval 0
#   vrrp_gna_interval 0
}

vrrp_script chk_nginx {
        script &quot;/etc/keepalived/chk_nginx.sh&quot;
        interval 2
        weight 2
        fall 3
        rise 2
}


vrrp_instance VI_1 {
    state SLAVE     #修改角色
    interface eth0
    virtual_router_id 51
    priority 90     #修改优先级
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }

    track_script {
        chk_nginx
    }

    virtual_ipaddress {
        172.16.88.178
    }
}
</code></pre>

<h4>测试</h4>
<p>启动nginx+keepalived服务(两台均启动)</p>
<pre class="codehilite"><code>/usr/sbin/ngix  #启动nginx
service keepalived start    #启动keepalived
</code></pre>

<p>在优先级较高的这条查看ip</p>
<pre class="codehilite"><code>ip addr
eth0:mtu 1500 qdisc pfifo_fast state UP qlen 1000
link/ether 52:54:00:0c:47:79 brd ff:ff:ff:ff:ff:ff
inet 172.16.88.179/23 brd 172.16.89.255 scope global eth0
inet 172.16.88.178/23 scope global secondary eth0   #发现多了一个虚拟ip
inet6 fe80::5054:ff:fe0c:4779/64 scope link 
   valid\_lft forever preferred\_lft forever
</code></pre>

<p>注意:此时在优先级低的服务器上是看不到这个虚拟ip的</p>
<p>模拟master(172.16.88.179)宕机，关闭keepalived</p>
<p>此时查看ip,发现虚拟IP漂移到SLAVE(172.16.88.180)上了</p>
        </div>
        
    </div>



                


        </div>

    </div>
    <footer>
        
        <p>&copy; 2024 | 我的博客. 保留所有权利。</p>
    <!--    <p><a href="/privacy">隐私政策</a> | <a href="/terms">使用条款</a></p>-->
        
    </footer>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <!-- 在页面加载完成后启用代码高亮 -->
    <script>
        // 等待页面加载完成后执行高亮
        document.addEventListener('DOMContentLoaded', function() {
            // 启用 highlight.js 代码高亮
            hljs.highlightAll();
        });
    </script>


</html>