<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nginx常用配置汇总</title>
    <link rel="icon" href="../static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="../static/css/styles.css"> <!-- 静态文件的链接 -->
    <!-- 引入 highlight.js 的 CSS 样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

</head>
<body>
    <header>
        <div class="navbar container">
            <div class="menu">
                <div class="nav-title"><a href="/index.html">各自花开</a></div>
                <ul class="nav-menu">
                    
                        <li><a href="/index.html">首页</a></li>
                        <li><a href="/categories.html">分类</a>
                        <li><a href="/tags.html">标签</a>






                        <li><a href="webnav.html">网址导航</a></li>
                        <li><a href="https://www.baidu.com" target="_blank">资源分享
                        <!-- 外部链接图标 -->
                        <img src="../static/img/分享_share.png" alt="外部链接" style="position: absolute; top: 0; right: 0; width: 12px; height: 12px;transform: translateX(100%)">
                        </a></li>
                        <li><a href="/search.html">搜索</a></li>
                    
                </ul>
            </div>
        </div>
    </header>
    <div id="app" class="container">

            
            


        <div class="main container">
                
    <div class="content article-content">
        <h3>nginx常用配置汇总</h3>
        <div class="tag-container">
        








            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>linux</a>
            </span>
            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>nginx</a>
            </span>
            

        </div>
        
        <div class="container article">
            <h2>nginx的匹配规则</h2>
<pre class="codehilite"><code class="language-bash">~      #波浪线表示执行一个正则匹配，区分大小写
~*    #表示执行一个正则匹配，不区分大小写
^~    #^~表示普通字符匹配，如果该选项匹配，只匹配该选项，不匹配别的选项，一般用来匹配目录
=      #进行普通字符精确匹配
@     #&quot;@&quot; 定义一个命名的 location，使用在内部定向时，例如 error_page, try_files


#举例： 匹配文件后缀名
~ *.(gif|jpg|jpeg|png|bmp|swf)$
</code></pre>

<h2>nginx常用代理配置参数</h2>
<pre class="codehilite"><code class="language-bash">location / {
    proxy_pass http://xxxx；
    proxy_redirect off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</code></pre>

<h2>nginx配置ws协议访问</h2>
<p>在location配置段内填写如下参数</p>
<pre class="codehilite"><code class="language-bash">proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection &quot;upgrade&quot;;
</code></pre>

<h2>rewrite</h2>
<pre class="codehilite"><code class="language-bash">location / {
    rewrite ^(.*) http://new.domain.com permanent;
    } 
</code></pre>

<h2>匹配url开头代理</h2>
<pre class="codehilite"><code class="language-bash">location ~* (^/api){
    proxy_pass http://$ipnew:port;
    ...
}
</code></pre>

<h2>根据各种请求参数匹配进行跳转</h2>
<pre class="codehilite"><code class="language-bash">location ~* (^/api){

    #根据http_user_agent请求头类型跳转
    if ( $http_user_agent ~* &quot;iPhone|Android&quot; ) {
        rewrite (.*) http://www.xxx.com/mobile$1 permanent;
        break;
        }

    #根据http_referer跳转
    if ( $http_referer ~* &quot;/phone/w/|/p2/&quot; ) {
                proxy_pass proxy_pass http://$ipnew02:port;
                add_header Cache-Control no-store;
                break;
        }
    proxy_pass http://$ipnew:port;
    include $nginx_prefix/conf/proxy.conf;
}
</code></pre>

<h2>nginx多重条件匹配</h2>
<pre class="codehilite"><code class="language-bash">匹配当请求是&quot;POST&quot;请求且是jpg结尾的文件时，返回503
set $flag 0;
if ( $request_method = &quot;POST&quot; ) {
    set $flag &quot;${flag}1&quot;;
}
if ( $url ~ \.jpg$ ) {
    set $flag &quot;${flag}2&quot;;
}
if ( $flag = &quot;012&quot; ) {
    return 503;
}
</code></pre>

<h2>nginx配置ssl证书</h2>
<p>在具体配置段内添加</p>
<pre class="codehilite"><code class="language-bash">ssl on; # 或者使用listen 443 ssl;
ssl_certificate ssl.crt;    #ssl证书具体位置
ssl_certificate_key ssl.key;
ssl_session_timeout 5m;
ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
ssl_protocols TLSv1 TLSv1.1 TLSv1.2;。
ssl_prefer_server_ciphers on;
</code></pre>

<h2>限制指定IP访问</h2>
<p>具体配置如下<br />
在nginx的代理配置文件中添加如下配置,返回状态码403</p>
<pre class="codehilite"><code class="language-bash">        set $http_status_num  0;
        if ($http_x_forwarded_for = '172.16.1.35') {
                set $http_status_num 1;
        }
        if ($http_x_forwarded_for = '172.16.1.142') {
                set $http_status_num 1;
        }

        if ($http_status_num != 1) {
                return 403;
        }
</code></pre>

<!--more-->
<h2>Nginx常见问题—alias和root的区别</h2>
<pre class="codehilite"><code class="language-bash">#alias
server {
    listen 80;
    index index.html;
    location /request_path/code/ {
         alias  /local_path/code;
    }
}

#root
server {
    listen 80;
    index index.html;
    location /request_path/code/ {
         root /local_path/code;
    }
}
</code></pre>

<p>在上面配置文件中，如果使用的是alias，那么实际请求路径为/local_path/code；如果使用的是root，实际请求路径为/local_path/code/request_path/code。也就是说root的请求路径是root+location的地址，而alias则是跳转到alias所指定的目录</p>
<h2>nginx日志切割方法</h2>
<p>新建nginx日志分割脚本</p>
<pre class="codehilite"><code class="language-bash">vim nginx_log_cut.sh
#!/bin/bash
Logs_PATH=/usr/local/nginx/logs/access
Yesterday=$(date -d &quot;yesterday&quot; +%Y%m%d)
mv ${Logs_PATH}/access.log ${Logs_PATH}/access_${Yesterday}.log
kill -USR1 $(cat /var/run/nginx.pid)
</code></pre>

<p>添加计划任务,每天的0点执行分割</p>
<pre class="codehilite"><code class="language-bash">crontab -e
#添加
0 0 * * * /bin/bash /$scripts_path/nginx_log_cut.sh
</code></pre>
        </div>
        
    </div>



                


        </div>

    </div>
    <footer>
        
        <p>&copy; 2024 | 我的博客. 保留所有权利。</p>
    <!--    <p><a href="/privacy">隐私政策</a> | <a href="/terms">使用条款</a></p>-->
        
    </footer>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <!-- 在页面加载完成后启用代码高亮 -->
    <script>
        // 等待页面加载完成后执行高亮
        document.addEventListener('DOMContentLoaded', function() {
            // 启用 highlight.js 代码高亮
            hljs.highlightAll();
        });
    </script>


</html>