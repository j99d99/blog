<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>strongswan配置l2tpd/ipsec连接VPN</title>
    <link rel="icon" href="../static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="../static/css/styles.css"> <!-- 静态文件的链接 -->
    <!-- 引入 highlight.js 的 CSS 样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

</head>
<body>
    <header>
        <div class="navbar container">
            <div class="menu">
                <div class="nav-title"><a href="/index.html">各自花开</a></div>
                <ul class="nav-menu">
                    
                        <li><a href="/index.html">首页</a></li>
                        <li><a href="/categories.html">分类</a>
                        <li><a href="/tags.html">标签</a>






                        <li><a href="webnav.html">网址导航</a></li>
                        <li><a href="https://www.baidu.com" target="_blank">资源分享
                        <!-- 外部链接图标 -->
                        <img src="../static/img/分享_share.png" alt="外部链接" style="position: absolute; top: 0; right: 0; width: 12px; height: 12px;transform: translateX(100%)">
                        </a></li>
                        <li><a href="/search.html">搜索</a></li>
                    
                </ul>
            </div>
        </div>
    </header>
    <div id="app" class="container">

            
            


        <div class="main container">
                
    <div class="content article-content">
        <h3>strongswan配置l2tpd/ipsec连接VPN</h3>
        <div class="tag-container">
        








            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>linux</a>
            </span>
            

        </div>
        
        <div class="container article">
            <h2>安装软件</h2>
<ol>
<li>安装依赖</li>
</ol>
<pre class="codehilite"><code class="language-bash">yum install pam-devel openssl-devel  make  gcc  gmp-devel wget -y
</code></pre>

<ol>
<li>安装strongswan</li>
</ol>
<pre class="codehilite"><code class="language-bash">wget http://download.strongswan.org/strongswan-5.5.1.tar.gz
tar xzf strongswan-5.5.1.tar.gz
cd strongswan-5.5.1

./configure  --enable-eap-identity --enable-eap-md5 \
--enable-eap-mschapv2 --enable-eap-tls --enable-eap-ttls --enable-eap-peap \
--enable-eap-tnc --enable-eap-dynamic --enable-eap-radius --enable-xauth-eap \
--enable-xauth-pam  --enable-dhcp  --enable-openssl  --enable-addrblock --enable-unity  \
--enable-certexpire --enable-radattr --enable-tools --enable-openssl --disable-gmp

make &amp;&amp; make install
</code></pre>

<ol>
<li>安装xl2tpd,httpd</li>
</ol>
<pre class="codehilite"><code class="language-bash">yum install xl2tpd httpd
</code></pre>

<h2>安装证书</h2>
<ol>
<li>生成CA证书私钥</li>
</ol>
<pre class="codehilite"><code class="language-bash">ipsec pki --gen --outform pem &gt; ca.pem
</code></pre>

<ol>
<li>签名CA证书</li>
</ol>
<pre class="codehilite"><code class="language-bash">ipsec pki --self --in ca.pem --dn &quot;C=com, O=myvpn, CN=VPN CA&quot; \
--ca --outform pem &gt;ca.cert.pem
</code></pre>

<ol>
<li>生成服务器证书使用的私钥</li>
</ol>
<pre class="codehilite"><code class="language-bash">ipsec pki --gen --outform pem &gt; server.pem
</code></pre>

<ol>
<li>使用CA证书签发服务器证书
<strong>说明:</strong>
将下面命令中的<code>121.xx.xx.82</code>替换成自己服务器IP地址或域名，<code>C=</code>和<code>O=</code>的值保持与前面的信息一致</li>
</ol>
<pre class="codehilite"><code class="language-bash">ipsec pki --pub --in server.pem | ipsec pki --issue --cacert ca.cert.pem \
--cakey ca.pem --dn &quot;C=com, O=myvpn, CN=121.xx.xx.82&quot; \
--san=&quot;121.xx.xx.82&quot; --flag serverAuth --flag ikeIntermediate  \
--outform pem &gt; server.cert.pem
</code></pre>

<ol>
<li>生成客户端使用私钥</li>
</ol>
<pre class="codehilite"><code class="language-bash">ipsec pki --gen --outform pem &gt; client.pem
</code></pre>

<ol>
<li>使用CA证书签发客户端证书
<strong>说明:</strong>
生成的ca.cert.pem证书复制一份命名为ca.cert.cer提供给手机客户端使用，<code>C=</code>和<code>O=</code>的值保持与前面的信息一致</li>
</ol>
<pre class="codehilite"><code class="language-bash">ipsec pki --pub --in client.pem | ipsec pki --issue --cacert ca.cert.pem \
--cakey ca.pem --dn &quot;C=com, O=myvpn, CN=VPN Client&quot;  \
--outform pem &gt; client.cert.pem
</code></pre>

<ol>
<li>生成pkcs12用户证书，使用<code>RSA</code>模式连接时使用此证书，令中的<code>-caname</code>后面的引号里的值必须要与前面第二步CA中的<code>CN=</code>的值保持一致</li>
</ol>
<pre class="codehilite"><code class="language-bash">openssl pkcs12 -export -inkey client.pem -in client.cert.pem \
-name &quot;client&quot; -certfile ca.cert.pem -caname &quot;VPN CA&quot;  \
-out client.cert.p12
</code></pre>

<ol>
<li>服务器证书安装</li>
</ol>
<pre class="codehilite"><code class="language-bash">cp -r ca.cert.pem /usr/local/etc/ipsec.d/cacerts/
cp -r server.cert.pem /usr/local/etc/ipsec.d/certs/
cp -r server.pem /usr/local/etc/ipsec.d/private/
cp -r client.cert.pem /usr/local/etc/ipsec.d/certs/
cp -r client.pem  /usr/local/etc/ipsec.d/private/
</code></pre>

<h2>配置</h2>
<p>配置主要涉及到如下几个文件</p>
<p>一、 xl2tpd相关配置</p>
<ol>
<li>/etc/ppp/options.xl2tpd</li>
</ol>
<pre class="codehilite"><code class="language-bash">cat /etc/ppp/options.xl2tpd
refuse-pap
refuse-chap
refuse-mschap
require-mschap-v2


noccp
auth
#crtscts
mtu 1410
mru 1410
nodefaultroute
#lock
proxyarp
#silent
ms-dns 8.8.8.8
ms-dns 8.8.4.4
</code></pre>

<ol>
<li>/etc/ppp/chap-secrets</li>
</ol>
<pre class="codehilite"><code class="language-bash">cat /etc/ppp/chap-secrets
# Secrets for authentication using CHAP
# client        server  secret                  IP addresses
&quot;test&quot;  *       &quot;123456&quot;        *
</code></pre>

<ol>
<li>/etc/xl2tpd/xl2tpd.conf</li>
</ol>
<pre class="codehilite"><code class="language-bash">cat /etc/xl2tpd/xl2tpd.conf
[global]
port = 1701

[lns default]
ip range = 10.10.0.2-10.10.0.254
local ip = 10.10.0.1
length bit = yes
refuse pap = yes
refuse chap = yes
require authentication = yes
name = l2tp
pppoptfile = /etc/ppp/options.xl2tpd
</code></pre>

<p>二、 strongswan相关配置</p>
<ol>
<li>/usr/local/etc/strongswan.conf</li>
</ol>
<pre class="codehilite"><code class="language-bash">cat /usr/local/etc/strongswan.conf 
# strongswan.conf - strongSwan configuration file
#
# Refer to the strongswan.conf(5) manpage for details
#
# Configuration changes should be made in the included files

charon {
        load_modular = yes
        duplicheck.enable = no
        compress = yes
        plugins {
                include strongswan.d/charon/*.conf
        }
        dns1 = 8.8.8.8
        dns2 = 8.8.4.4
        nbns1 = 8.8.8.8
        nbns2 = 8.8.4.4
}
filelog {
    /tmp/charon.log {
        # add a timestamp prefix
        time_format = %b %e %T
        # prepend connection name, simplifies grepping
        ike_name = yes
        # overwrite existing files
        append = no
        # increase default loglevel for all daemon subsystems
        default = 1
        # flush each line to disk
        flush_line = yes
    }
}


include strongswan.d/*.conf
</code></pre>

<ol>
<li>/usr/local/etc/ipsec.secrets</li>
</ol>
<pre class="codehilite"><code class="language-bash">cat /usr/local/etc/ipsec.secrets 
# ipsec.secrets - strongSwan IPsec secrets file
: RSA server.pem
: PSK &quot;123456&quot;
: XAUTH &quot;123456&quot;
test : EAP &quot;123456&quot; 
test %any : EAP &quot;123456&quot; 
</code></pre>

<ol>
<li>/usr/local/etc/ipsec.conf</li>
</ol>
<pre class="codehilite"><code class="language-bash">cat /usr/local/etc/ipsec.conf 
config setup
    uniqueids=never
    charondebug=&quot;chd 2,ike 1 ,ike 2, knl 2, net 2, esp 2, dmn 2,  mgr 2, lib 1, cfg 1, enc 1&quot;
conn QVPN_L2TP/IPsec-PSK
    keyexchange=ikev1
    left=192.168.0.61
    leftsubnet=0.0.0.0/0
    leftprotoport=17/1701
    authby=secret
    leftfirewall=no
    right=%any
    rightprotoport=17/%any
    type=transport
    auto=add
conn QVPN_L2TP/IPsec-RSA
    keyexchange=ikev1
    keyingtries=1
    left=%any
    leftprotoport=udp/l2tp
    leftid=192.168.0.61
    #leftsubnet=0.0.0.0/0
    leftcert=server.cert.pem
    #leftsendcert=always
    right=%any
    rightprotoport=udp/%any
    type=transport
    auto=add

conn QVPN_IPsec-Xauth-PSK
    keyexchange=ikev1
    left=%defaultroute
    leftauth=psk
    leftsubnet=0.0.0.0/0
    right=%any
    rightauth=psk
    rightauth2=xauth
    rightsourceip=10.10.0.0/24
    rightsubnet=0.0.0.0/0
    auto=add
conn QVPN_IPsec-Xauth-RSA
    keyexchange=ikev1
    fragmentation = yes
    leftsubnet=0.0.0.0/0
    leftid=192.168.0.61
    leftcert=server.cert.pem
    leftsendcert=always
    # secure cipher suits
    #ike=aes128-sha1-modp1536,aes128-sha1-modp1024,aes128-md5-modp1536,aes128-md5-modp1024,3des-sha1-modp1536,3des-sha1-modp1024,3des-md5-modp1536,3des-md5-modp1024
    #esp=aes128-sha1-modp1536,aes128-sha1-modp1024,aes128-md5-modp1536,aes128-md5-modp1024,3des-sha1-modp1536,3des-sha1-modp1024,3des-md5-modp1536,3des-md5-modp1024
    rightsourceip=10.10.0.0/24
    rightsubnet=0.0.0.0/0
    rightca=&quot;C=CN, O=QiKuVPN, CN=360QiKU&quot;
    rightcert=client.cert.pem
    rightauth2=xauth
    xauth=server
    auto=add
conn QVPN_IPsec-Hybrid-RSA
    keyexchange=ikev1
    leftid=192.168.0.61
    leftsubnet=0.0.0.0/0
    leftcert=server.cert.pem
    leftsendcert=always
    leftauth=pubkey
    leftfirewall=yes
    right=%any
    rightsourceip=10.10.0.0/24
    rightsubnet=0.0.0.0/0
    rightauth=xauth
    xauth=server
    auto=add

conn ios_ikev2
    keyexchange=ikev2
    ike=aes256-sha256-modp2048,3des-sha1-modp2048,aes256-sha1-modp2048!
    esp=aes256-sha256,3des-sha1,aes256-sha1!
    rekey=no
    left=%defaultroute
    leftid=192.168.0.61
    leftsendcert=always
    leftsubnet=0.0.0.0/0
    leftcert=server.cert.pem
    right=%any
    rightauth=eap-mschapv2
    rightsourceip=10.31.4.0/24
    rightsendcert=never
    eap_identity=%any
    dpdaction=clear
    fragmentation=yes
    auto=add
conn windows7
    keyexchange=ikev2
    ike=aes256-sha1-modp1024!
    rekey=no
    left=%defaultroute
    leftauth=pubkey
    leftsubnet=0.0.0.0/0
    leftcert=server.cert.pem
    right=%any
    rightauth=eap-mschapv2
    rightsourceip=10.31.5.0/24
    rightsendcert=never
    eap_identity=%any
    auto=add
</code></pre>

<h2>配置iptables和内核参数</h2>
<ol>
<li>内核参数配置</li>
</ol>
<pre class="codehilite"><code class="language-bash">cat &gt;&gt; /etc/sysctl.conf&lt;&lt;-EOF
net.ipv4.ip_forward = 1
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.all.send_redirects = 0
EOF
</code></pre>

<ol>
<li>iptables配置
<strong>说明</strong></li>
<li><code>10.10.0.0</code>根据<code>/etc/xl2tpd/xl2tpd.conf</code>文件设置的IP进行修改</li>
<li><code>eth0</code>根据具体的服务器网卡名进行修改</li>
</ol>
<pre class="codehilite"><code class="language-bash">iptables -A INPUT -p tcp --dport 80 -j ACCEPT
iptables -A INPUT -p udp --dport 500 -j ACCEPT
iptables -A INPUT -p udp --dport 4500 -j ACCEPT
iptables -A INPUT -p udp --dport 1701 -j ACCEPT
iptables -A INPUT -p udp --dport 1723 -j ACCEPT
iptables -t nat -A POSTROUTING -s 10.10.0.0/24 -o eth0 -j MASQUERADE
iptables -A FORWARD -s 10.10.0.0/24 -j ACCEPT
iptables -t nat -A POSTROUTING -s 10.10.0.0/24 -o eth0 -m policy --dir out --pol none -j MASQUERADE
</code></pre>

<h2>配置证书下载</h2>
<ol>
<li>拷贝证书</li>
</ol>
<pre class="codehilite"><code class="language-bash">mkdir /var/www/html/key
cp -p ca.cert.pem  /var/www/html/key/ca.cert.cer
cp -p ca.cert.pem  /var/www/html/key/
cp -p client.cert.p12  /var/www/html/key/
</code></pre>

<ol>
<li>添加apach配置段</li>
</ol>
<pre class="codehilite"><code class="language-bash"># 配置apache登录账户密码
htpasswd -c -b /etc/httpd/htpasdb  test  123456

# 在apache配置文件/etc/httpd/conf/httpd.conf最后追加：

&lt;directory /&gt;
options indexes
AuthType Basic
AuthName &quot;!!!&quot;
AuthBasicProvider file
AuthUserFile /etc/httpd/htpasdb
Require user test

&lt;/directory&gt;
</code></pre>

<ol>
<li>启动httpd服务</li>
</ol>
<pre class="codehilite"><code class="language-bash">service httpd restart
</code></pre>

<h2>测试</h2>
<p>省略...</p>
        </div>
        
    </div>



                


        </div>

    </div>
    <footer>
        
        <p>&copy; 2024 | 我的博客. 保留所有权利。</p>
    <!--    <p><a href="/privacy">隐私政策</a> | <a href="/terms">使用条款</a></p>-->
        
    </footer>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <!-- 在页面加载完成后启用代码高亮 -->
    <script>
        // 等待页面加载完成后执行高亮
        document.addEventListener('DOMContentLoaded', function() {
            // 启用 highlight.js 代码高亮
            hljs.highlightAll();
        });
    </script>


</html>