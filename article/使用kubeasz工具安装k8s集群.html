<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>使用kubeasz工具安装k8s集群</title>
    <link rel="icon" href="../static/img/favicon.png" type="image/png">
    <link rel="stylesheet" href="../static/css/styles.css"> <!-- 静态文件的链接 -->
    <!-- 引入 highlight.js 的 CSS 样式 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">

</head>
<body>
    <header>
        <div class="navbar container">
            <div class="menu">
                <div class="nav-title"><a href="/index.html">各自花开</a></div>
                <ul class="nav-menu">
                    
                        <li><a href="/index.html">首页</a></li>
                        <li><a href="/categories.html">分类</a>
                        <li><a href="/tags.html">标签</a>






                        <li><a href="webnav.html">网址导航</a></li>
                        <li><a href="https://www.baidu.com" target="_blank">资源分享
                        <!-- 外部链接图标 -->
                        <img src="../static/img/分享_share.png" alt="外部链接" style="position: absolute; top: 0; right: 0; width: 12px; height: 12px;transform: translateX(100%)">
                        </a></li>
                        <li><a href="/search.html">搜索</a></li>
                    
                </ul>
            </div>
        </div>
    </header>
    <div id="app" class="container">

            
            


        <div class="main container">
                
    <div class="content article-content">
        <h3>使用kubeasz工具安装k8s集群</h3>
        <div class="tag-container">
        








            
                <span>
                <img src="../static/img/标签_tag-one.png" class="img-icon">
                <a>kubernetes</a>
            </span>
            

        </div>
        
        <div class="container article">
            <p>项目github地址<code>https://github.com/easzlab/kubeasz</code></p>
<h2>一、集群规划和安装前准备工作</h2>
<h3>1. 集群规划</h3>
<p>| 角色 | 数量 | 描述 |
| --- | --- | --- |
| 管理节点 | 1 | 运行ansible/ezctl脚本，可复用master节点或者单独一台 |
| etcd节点 | 3 | etcd集群，奇数节点 |
| master节点 | 3 | 高可用集群至少2台master |
| node节点 | N台 | 根据需求自行增减节点 |</p>
<h3>2. 各节点时间同步</h3>
<p>2.1 第一种同步方法，各节点执行如下命令</p>
<pre class="codehilite"><code class="language-bash">ntpdate time.windows.com
</code></pre>

<p>2.2 第二种是安装chrony
待补充..</p>
<h3>3. 内核升级到最新</h3>
<pre class="codehilite"><code class="language-bash"># 载入公钥
rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-lt.x86_64
yum remove kernel-tools-libs.x86_64 kernel-tools.x86_64 -y
yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-lt-tools.x86_64

#查看默认启动顺序
awk -F\' '$1==&quot;menuentry &quot; {print $2}' /etc/grub2.cfg  
CentOS Linux (4.4.183-1.el7.elrepo.x86_64) 7 (Core)  
CentOS Linux (3.10.0-327.10.1.el7.x86_64) 7 (Core)  
CentOS Linux (0-rescue-c52097a1078c403da03b8eddeac5080b) 7 (Core)
#默认启动的顺序是从0开始，新内核是从头插入（目前位置在0，而4.4.4的是在1），所以需要选择0。
grub2-set-default 0  
#重启并检查
reboot
</code></pre>

<h3>4. 管理节点配置</h3>
<h4>4.1 安装ansible工具</h4>
<p>管理节点依赖ansible批量操作工具来管理各节点，所以需要安装ansible</p>
<pre class="codehilite"><code class="language-bash"># 注意pip 21.0以后不再支持python2和python3.5，需要如下安装
# To install pip for Python 2.7 install it from https://bootstrap.pypa.io/2.7/ :
# 第一种安装
curl -O https://bootstrap.pypa.io/pip/2.7/get-pip.py
python get-pip.py
#或者第二种安装
yum install -y epel-release
yum install -y python-pip

# 升级pip
python -m pip install --upgrade &quot;pip &lt; 21.0&quot;
pip install -U 'setuptools&lt;45'

# pip安装ansible(国内如果安装太慢可以直接用pip阿里云加速)
pip install ansible -i https://mirrors.aliyun.com/pypi/simple/
</code></pre>

<h4>4.2 配置各节点免秘钥登录</h4>
<p>管理节点需要管理其他节点，方便脚本执行等，配置管理节点可免秘钥登录到其他各节点，包括自身</p>
<pre class="codehilite"><code class="language-bash"># 更安全 Ed25519 算法
ssh-keygen -t ed25519 -N '' -f ~/.ssh/id_ed25519
# 或者传统 RSA 算法
ssh-keygen -t rsa -b 2048 -N '' -f ~/.ssh/id_rsa

ssh-copy-id $IPs #$IPs为所有节点地址包括自身，按照提示输入yes 和root密码
</code></pre>

<h4>4.3 下载准备安装所需软件</h4>
<p>下载安装k8s需要的所有文件，文件下载目录<code>/etc/kubeasz</code></p>
<pre class="codehilite"><code class="language-bash"># 下载工具脚本easzup，举例使用kubeasz版本2.0.2
export release=3.0.0
curl -C- -fLO --retry 3 https://github.com/easzlab/kubeasz/releases/download/${release}/ezdown
chmod +x ./ezdown
# 使用工具脚本下载
./ezdown -D
</code></pre>

<h2>二、 使用kubeasz工具的ezctl命令安装k8s集群</h2>
<p><code>ezctl</code>命令可以创建多个集群，通过不同的集群名称区分不同的集群，现在创建第一个k8s集群,假设集群名<code>k8s-01</code></p>
<h3>生成集群创建配置文件</h3>
<p>通过命令生成k8s-01集群创建需要的配置文件，生成的配置文件保存在<code>/etc/kubeasz/clusters/k8s-01/</code>,在目录下我们会看到两个配置文件<code>hosts</code>和<code>config.yml</code></p>
<pre class="codehilite"><code class="language-bash"># 生成创建集群的配置文件
cd /etc/kubeasz
ezctl new k8s-01
</code></pre>

<h3>根据集群规划修改配置文件</h3>
<p>生成的两个文件是初始配置文件。我们需要根据集群的规划进行自定义修改或调整
<code>hosts</code>文件主要配置的信息是集群各节点的服务器信息
<code>config.yml</code>文件主要配置创建k8s时的一些组件配置信息</p>
<h3>开始安装</h3>
<p>安装很简单，可以一步一步的安装，也可以通过<code>all</code>参数一次安装完成，具体的安装使用可以通过帮助命令查看</p>
<pre class="codehilite"><code class="language-bash">./ezctl setup --help
Usage: ezctl setup &lt;cluster&gt; &lt;step&gt;
available steps:
    01     prepare         to prepare CA/certs &amp; kubeconfig &amp; other system settings 
    02     etcd            to setup the etcd cluster
    03     runtime         to setup the container runtime(docker or containerd)
    04     kube-master     to setup the master nodes
    05     kube-node       to setup the worker nodes
    06     network         to setup the network plugin
    07     cluster-addon   to setup other useful plugins
    all                    to run 01~07 all at once

examples: ./ezctl setup test-k8s 01
          ./ezctl setup test-k8s 02
          ./ezctl setup test-k8s all
</code></pre>

<p>我们要创建k8s-01集群，只需要根据帮助文档进行安装</p>
<pre class="codehilite"><code class="language-bash">cd /etc/kubeasz
# 一步到位安装
./ezctl setup k8s-01 all

# 分步安装
./ezctl setup k8s-01 01
./ezctl setup k8s-01 02
...
</code></pre>

<h3>配置master节点负载均衡</h3>
<ul>
<li>
<p>修改host文件，修改ex-lb配置段</p>
</li>
<li>
<p>执行ex-lb相关的roles任务</p>
</li>
</ul>
<pre class="codehilite"><code class="language-bash">ansible-playbook -i ../clusters/k8s-01/hosts ex-lb.yml
</code></pre>

<ul>
<li>执行成功后修改~/.kube/config文件，将server地址修改成hosts里ex-lb段配置的VIP地址和端口号即可</li>
</ul>
<h2>三、 集群管理常见操作</h2>
<pre class="codehilite"><code class="language-bash">./ezctl --help
Usage: ezctl COMMAND [args]
-------------------------------------------------------------------------------------
Cluster setups:
    list                             to list all of the managed clusters
    checkout    &lt;cluster&gt;            to switch default kubeconfig of the cluster
    new         &lt;cluster&gt;            to start a new k8s deploy with name 'cluster'
    setup       &lt;cluster&gt;  &lt;step&gt;    to setup a cluster, also supporting a step-by-step way
    start       &lt;cluster&gt;            to start all of the k8s services stopped by 'ezctl stop'
    stop        &lt;cluster&gt;            to stop all of the k8s services temporarily
    upgrade     &lt;cluster&gt;            to upgrade the k8s cluster
    destroy     &lt;cluster&gt;            to destroy the k8s cluster
    backup      &lt;cluster&gt;            to backup the cluster state (etcd snapshot)
    restore     &lt;cluster&gt;            to restore the cluster state from backups
    start-aio                        to quickly setup an all-in-one cluster with 'default' settings

Cluster ops:
    add-etcd    &lt;cluster&gt;  &lt;ip&gt;      to add a etcd-node to the etcd cluster
    add-master  &lt;cluster&gt;  &lt;ip&gt;      to add a master node to the k8s cluster
    add-node    &lt;cluster&gt;  &lt;ip&gt;      to add a work node to the k8s cluster
    del-etcd    &lt;cluster&gt;  &lt;ip&gt;      to delete a etcd-node from the etcd cluster
    del-master  &lt;cluster&gt;  &lt;ip&gt;      to delete a master node from the k8s cluster
    del-node    &lt;cluster&gt;  &lt;ip&gt;      to delete a work node from the k8s cluster

Extra operation:
    kcfg-adm    &lt;cluster&gt;  &lt;args&gt;    to manage client kubeconfig of the k8s cluster

Use &quot;ezctl help &lt;command&gt;&quot; for more information about a given command.
</code></pre>

<h3>1. 添加和删除master节点</h3>
<p>1.1 添加master节点</p>
<pre class="codehilite"><code class="language-bash">./ezctl add-master k8s-01 172.16.88.113
</code></pre>

<p>1.2 删除master节点</p>
<pre class="codehilite"><code class="language-bash">./ezctl del-master k8s-01 172.16.88.113
</code></pre>

<h3>2. 添加和删除node节点</h3>
<p>2.1 添加node节点
将172.16.88.115添加到k8s-01集群的node节点</p>
<pre class="codehilite"><code class="language-bash">./ezctl add-node k8s-01 172.16.88.115
</code></pre>

<p>2.2 删除node节点</p>
<pre class="codehilite"><code class="language-bash">./ezctl del-node k8s-01 172.16.88.115
</code></pre>

<h3>3. 给节点打标签、删除标签</h3>
<pre class="codehilite"><code class="language-bash"># 打标签
kubectl label node 172.16.88.205 app=ingress-nginx

# 删除标签
kubectl label node 172.16.88.205 app-
</code></pre>
        </div>
        
    </div>



                


        </div>

    </div>
    <footer>
        
        <p>&copy; 2024 | 我的博客. 保留所有权利。</p>
    <!--    <p><a href="/privacy">隐私政策</a> | <a href="/terms">使用条款</a></p>-->
        
    </footer>

</body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
 <!-- 在页面加载完成后启用代码高亮 -->
    <script>
        // 等待页面加载完成后执行高亮
        document.addEventListener('DOMContentLoaded', function() {
            // 启用 highlight.js 代码高亮
            hljs.highlightAll();
        });
    </script>


</html>